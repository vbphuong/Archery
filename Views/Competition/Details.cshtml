@{
    ViewData["Title"] = "Competition Details";
    var competition = ViewBag.Competition;
    var compId = competition?.CompetitionID ?? 0;
}

<div class="container mt-4">
    <h2>Competition: @competition?.Name</h2>
    <p><strong>Date:</strong> @((competition?.Date ?? DateTime.MinValue).ToString("yyyy-MM-dd"))</p>
    <p><strong>Description:</strong> @competition?.Description</p>
    <hr />

    <div class="d-flex justify-content-between align-items-center mb-2">
        <h4>Rounds in this Competition</h4>
        <div id="actionsArea"></div>
    </div>

    <!-- Rounds Table -->
    <table class="table table-striped" id="roundTable">
        <thead>
            <tr>
                <th>Round</th>
                <th>Class</th>
                <th>Gender</th>
                <th>Equipment</th>
                <th>Has Equivalent</th>
                <th>Is Practice</th>
                <th>Status</th>
                <th>Added At</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <hr class="my-4" />

    <!-- Eligible Archers -->
    <div>
        <h4>Eligible Archers (drag into a round)</h4>
        <p class="text-muted">Only archers with Gender & Equipment set appear here.</p>
        <div id="archerArea" class="row g-2"></div>
    </div>

    <!-- ✅ Modal Add Round -->
    <div class="modal fade" id="roundModal" tabindex="-1" aria-labelledby="roundModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="addForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="roundModalLabel">Add Round to Competition</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p id="roundInfoText" class="text-muted">Select a round to see its details.</p>
                        <div class="mb-3">
                            <label for="roundSelect" class="form-label">Select Round</label>
                            <select class="form-select" id="roundSelect" required></select>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="hasEquivalent">
                            <label class="form-check-label" for="hasEquivalent">Has Equivalent</label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="isPractice">
                            <label class="form-check-label" for="isPractice">Is Practice</label>
                        </div>
                        <div class="mb-3">
                            <label for="statusSelect" class="form-label">Status</label>
                            <select id="statusSelect" class="form-select">
                                <option>NotStarted</option>
                                <option>Ongoing</option>
                                <option>Completed</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Add Round</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ✅ Modal Edit Round -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="editForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editModalLabel">Edit Round</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editRoundId" />
                        <div class="mb-3">
                            <label for="editRoundName" class="form-label">Round Name</label>
                            <input type="text" id="editRoundName" class="form-control" readonly />
                        </div>
                        <div class="form-check mb-2">
                            <input type="checkbox" class="form-check-input" id="editHasEquivalent">
                            <label for="editHasEquivalent" class="form-check-label">Has Equivalent</label>
                        </div>
                        <div class="form-check mb-2">
                            <input type="checkbox" class="form-check-input" id="editIsPractice">
                            <label for="editIsPractice" class="form-check-label">Is Practice</label>
                        </div>
                        <div class="mb-3">
                            <label for="editStatus" class="form-label">Status</label>
                            <select id="editStatus" class="form-select">
                                <option>NotStarted</option>
                                <option>Ongoing</option>
                                <option>Completed</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
$(function () {
    const compId = @compId;
    const getToken = () => localStorage.getItem('jwtToken');
    const decodeToken = () => {
        const t = getToken(); if (!t) return null;
        try { return JSON.parse(atob(t.split('.')[1])); } catch { return null; }
    };

    const role = (() => {
        const d = decodeToken();
        return d ? (d["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"] || d["role"]) : null;
    })();
    const canEdit = role === 'Admin' || role === 'Recorder';

    if (canEdit)
        $('#actionsArea').html('<button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#roundModal">➕ Add Round</button>');

    // ================= LOAD ROUNDS =================
    async function loadRounds() {
        const res = await fetch(`/api/CompetitionRoundAPI/GetByCompetition/${compId}`, {
            headers: { 'Authorization': 'Bearer ' + getToken() }
        });
        if (!res.ok) return alert('Failed to load rounds.');
        const list = await res.json();
        renderRoundTable(list);
    }

    async function loadArchersForRound(roundId) {
        const res = await fetch(`/api/CompetitionRoundAPI/GetArchersForRound/${compId}/${roundId}/Archers`, {
            headers: { 'Authorization': 'Bearer ' + getToken() }
        });
        const list = res.ok ? await res.json() : [];
        const $area = $(`#archers-${roundId}`);
        if (!list.length) return $area.html('<em>No archers yet.</em>');
        let html = '<div class="d-flex flex-wrap gap-2">';
        for (const a of list)
            html += `<div class="card p-2 shadow-sm" style="min-width:180px;">
                        <strong>${a.fullName}</strong><br/>
                        <small>${a.gender} — ${a.equipments.join(', ')}</small><br/>
                        <button class="btn btn-sm btn-outline-primary mt-1"
                            onclick="window.location.href='/CompetitionRound/Details?competitionId=${compId}&roundId=${roundId}&archerId=${a.archerID}'">
                            Details
                        </button>
                    </div>`;
        html += '</div>';
        $area.html(html);
    }

    async function renderRoundTable(list) {
        const $tbody = $('#roundTable tbody').empty();
        if (!list?.length) return $tbody.html('<tr><td colspan="9" class="text-center">No rounds added.</td></tr>');

        for (const r of list) {
            const editBtn = canEdit ? `<button class="btn btn-sm btn-warning edit-btn"
                data-roundid="${r.roundID}" data-roundname="${r.roundName}"
                data-hasequivalent="${r.hasEquivalent}" data-ispractice="${r.isPractice}"
                data-status="${r.status}">Edit</button>` : '';

            const removeBtn = canEdit ? `<button class="btn btn-sm btn-danger remove-btn" data-roundid="${r.roundID}">Remove</button>` : '';
            const detailsBtn = `<button class="btn btn-sm btn-info" onclick="window.location.href='/Score/Details?competitionId=${r.competitionID}&roundId=${r.roundID}'">Details</button>`;

            $tbody.append(`
                <tr data-roundid="${r.roundID}" data-haseq="${r.hasEquivalent}" data-gender="${r.gender}"
                    class="round-row droppable border border-1 border-secondary-subtle">
                    <td><strong>${r.roundName}</strong></td>
                    <td>${r.class || ''}</td>
                    <td>${r.gender || ''}</td>
                    <td>${r.equipmentName || ''}</td>
                    <td>${r.hasEquivalent || 'No'}</td>
                    <td>${r.isPractice || 'No'}</td>
                    <td>${r.status || ''}</td>
                    <td>${r.dateCreated ? new Date(r.dateCreated).toLocaleString() : '—'}</td>
                    <td>${editBtn} ${removeBtn} ${detailsBtn}</td>
                </tr>
                <tr><td colspan="9"><div id="archers-${r.roundID}" class="p-2"><em>Loading...</em></div></td></tr>`);
            await loadArchersForRound(r.roundID);
        }
        enableDropZones();
    }

    // ================= ADD ROUND =================
    async function loadRoundOptions() {
        const res = await fetch('/api/RoundAPI/GetAllRoundNames', {
            headers: { 'Authorization': 'Bearer ' + getToken() }
        });
        const rounds = await res.json();
        const $sel = $('#roundSelect').empty().append('<option value="">-- Select Round --</option>');
        rounds.forEach(r => $sel.append(`<option value="${r.roundID}">${r.name} — ${r.class} — ${r.gender} (${r.equipmentName})</option>`));
    }

    $('#addForm').on('submit', async ev => {
        ev.preventDefault();
        const payload = {
            competitionID: compId,
            roundID: parseInt($('#roundSelect').val()),
            hasEquivalent: $('#hasEquivalent').is(':checked') ? 'Yes' : 'No',
            isPractice: $('#isPractice').is(':checked') ? 'Yes' : 'No',
            status: $('#statusSelect').val()
        };
        const res = await fetch('/api/CompetitionRoundAPI/Add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + getToken() },
            body: JSON.stringify(payload)
        });
        if (res.ok) {
            bootstrap.Modal.getInstance(document.getElementById('roundModal')).hide();
            loadRounds();
        } else alert('❌ Failed to add round.');
    });

    // ================= EDIT ROUND =================
    $('#roundTable').on('click', '.edit-btn', function () {
        const r = $(this).data();
        $('#editRoundId').val(r.roundid);
        $('#editRoundName').val(r.roundname);
        $('#editIsPractice').prop('checked', r.ispractice === 'Yes');
        $('#editHasEquivalent').prop('checked', r.hasequivalent === 'Yes');
        $('#editStatus').val(r.status);
        $('#editModal').modal('show');
    });

    $('#editForm').on('submit', async e => {
        e.preventDefault();
        const id = $('#editRoundId').val();
        const payload = {
            hasEquivalent: $('#editHasEquivalent').is(':checked') ? 'Yes' : 'No',
            isPractice: $('#editIsPractice').is(':checked') ? 'Yes' : 'No',
            status: $('#editStatus').val()
        };
        const res = await fetch(`/api/CompetitionRoundAPI/Update/${compId}/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + getToken() },
            body: JSON.stringify(payload)
        });
        if (res.ok) {
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
            loadRounds();
        }
    });

    $('#roundTable').on('click', '.remove-btn', async function () {
        if (!confirm('Remove this round?')) return;
        await fetch(`/api/CompetitionRoundAPI/Delete/${compId}/${$(this).data('roundid')}`, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + getToken() }
        });
        loadRounds();
    });

    // ================= ARCHERS + DRAG & DROP =================
    async function loadArchers() {
        const res = await fetch('/api/ArcherAPI/GetAll', {
            headers: { 'Authorization': 'Bearer ' + getToken() }
        });
        const list = await res.json();
        const filtered = list.filter(a => a.gender && a.equipmentNames?.length);
        renderArchers(filtered);
    }

    function renderArchers(list) {
        const $a = $('#archerArea').empty();
        if (!list.length) return $a.html('<p>No eligible archers.</p>');
        list.forEach(a => {
            const eq = a.equipmentNames.join(', ');
            $a.append(`<div class="col-md-3">
                    <div class="card p-2 shadow-sm draggable" draggable="true"
                        data-archerid="${a.archerId}" data-gender="${a.gender}"
                        data-equipmentnames='${JSON.stringify(a.equipmentNames)}'>
                        <h6>${a.fullName || a.firstName + ' ' + a.lastName}</h6>
                        <small class="text-muted">${a.gender} — ${eq}</small>
                    </div></div>`);
        });
        enableDrag();
    }

    function enableDrag() {
        $('.draggable').on('dragstart', function (ev) {
            const archerId = Number($(this).attr('data-archerid'));
            const gender = $(this).attr('data-gender');
            const equipmentNames = JSON.parse($(this).attr('data-equipmentnames') || '[]');
            const payload = { archerId, gender, equipmentNames };
            ev.originalEvent.dataTransfer.setData('application/json', JSON.stringify(payload));
        });
    }

    function enableDropZones() {
        $('.droppable').on('dragover', ev => ev.preventDefault())
        .on('drop', async function (ev) {
            ev.preventDefault();
            const roundId = $(this).data('roundid');
            const hasEq = $(this).data('haseq');
            const roundGender = $(this).data('gender');
            const roundEquip = $(this).find('td:nth-child(4)').text().trim();

            let data = JSON.parse(ev.originalEvent.dataTransfer.getData('application/json'));
            let eqNames = Array.isArray(data.equipmentNames) ? data.equipmentNames : [];

            const eligible = (hasEq === 'Yes')
                ? eqNames.includes(roundEquip)
                : (data.gender === roundGender && eqNames.includes(roundEquip));

            if (!eligible) return alert('❌ Archer not eligible for this round.');

            const payload = { ArcherID: data.archerId, RoundID: roundId, CompetitionID: compId };
            const res = await fetch('/api/CompetitionRoundAPI/AssignArcherToRound', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + getToken() },
                body: JSON.stringify(payload)
            });
            if (res.ok) {
                alert('✅ Archer assigned!');
                loadRounds(); loadArchers();
            } else alert('❌ Failed to assign archer.');
        });
    }

    // ================= INIT =================
    loadRoundOptions();
    loadRounds();
    loadArchers();
});
    </script>
}
