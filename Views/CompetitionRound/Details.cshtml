@model IEnumerable<Archery.Models.Entity.ArcheryRange>
@{
    ViewData["Title"] = "Round Details";

    var competitionId = ViewBag.CompetitionId;
    var roundId = ViewBag.RoundId;
    var archerId = ViewBag.ArcherId;
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Round Details</h2>
        <a asp-controller="Competition" asp-action="Details" asp-route-id="@competitionId" class="btn btn-secondary">
            ← Back to Competition
        </a>
    </div>

    <!-- 🔢 Tổng điểm -->
    <div class="d-flex justify-content-end mb-3">
        <h5>Total Score: <span id="totalScore" class="text-primary fw-bold">0</span></h5>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title">Archer's Ranges</h5>
                <button id="btnAddRange" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addRangeModal" style="display:none;">
                    <i class="bi bi-plus-circle"></i> Add Range
                </button>
            </div>

            <table class="table table-bordered table-striped" id="rangeTable">
                <thead class="table-light">
                    <tr>
                        <th>Range ID</th>
                        <th>Distance</th>
                        <th>Target Face</th>
                        <th>Num Ends</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        foreach (var range in Model)
                        {
                            <tr data-rangeid="@range.RangeID">
                                <td>@range.RangeID</td>
                                <td>@range.Distance</td>
                                <td>@range.TargetFace</td>
                                <td>@range.NumEnds</td>
                                <td class="action-cell">
                                    <button class="btn btn-sm btn-info view-ends-btn" data-rangeid="@range.RangeID">
                                        <i class="bi bi-eye"></i> View Ends
                                    </button>
                                </td>
                            </tr>
                            <tr id="ends-row-@range.RangeID" class="d-none">
                                <td colspan="5">
                                    <div id="ends-container-@range.RangeID" class="p-2 border rounded bg-light">
                                        <em>Loading ends...</em>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="5" class="text-center">No ranges found for this archer.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ===================== 🟢 MODALS ===================== -->
<!-- Add Range Modal -->
<div class="modal fade" id="addRangeModal" tabindex="-1" aria-labelledby="addRangeLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addRangeLabel">Add New Range</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addRangeForm">
                    <div class="mb-3">
                        <label class="form-label">Distance</label>
                        <input type="number" class="form-control" id="addDistance" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Target Face</label>
                        <input type="text" class="form-control" id="addTargetFace" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Num Ends</label>
                        <input type="number" class="form-control" id="addNumEnds" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveAddRangeBtn">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Range Modal -->
<div class="modal fade" id="editRangeModal" tabindex="-1" aria-labelledby="editRangeLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editRangeLabel">Edit Range</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editRangeForm">
                    <input type="hidden" id="editRangeId">
                    <div class="mb-3">
                        <label class="form-label">Distance</label>
                        <input type="number" class="form-control" id="editDistance" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Target Face</label>
                        <input type="text" class="form-control" id="editTargetFace" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Num Ends</label>
                        <input type="number" class="form-control" id="editNumEnds" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveEditRangeBtn">Save changes</button>
            </div>
        </div>
    </div>
</div>

<!-- ===================================================== -->

@section Scripts {
    <script>
const competitionId = '@competitionId';
const roundId = '@roundId';
const archerId = '@archerId';

$(document).ready(async function () {
    // ===== JWT HELPERS =====
    function getToken() { return localStorage.getItem('jwtToken'); }
    function getDecodedToken() {
        const token = getToken();
        if (!token) return null;
        try { return JSON.parse(atob(token.split('.')[1])); } catch { return null; }
    }
    function getCurrentRole() {
        const decoded = getDecodedToken();
        if (!decoded) return null;
        return decoded['http://schemas.microsoft.com/ws/2008/06/identity/claims/role']
            || decoded['role'] || decoded['roles'] || null;
    }
    function getAuthHeaders() {
        const token = getToken();
        return token ? { 'Authorization': 'Bearer ' + token } : {};
    }

    const currentRole = getCurrentRole();
    const editable = ['Admin', 'Recorder'].includes(currentRole);
    if (editable) $("#btnAddRange").show();

    // ===== BUTTON EVENTS =====
    $('.view-ends-btn').on('click', async function () {
        const rangeId = $(this).data('rangeid');
        const $row = $(`#ends-row-${rangeId}`);
        const $container = $(`#ends-container-${rangeId}`);

        if ($row.hasClass('d-none')) {
            $row.removeClass('d-none');
            await loadEnds(rangeId, $container);
        } else {
            $row.addClass('d-none');
        }
    });

    if (editable) {
        $('#rangeTable tbody tr[data-rangeid]').each(function () {
            const id = $(this).data('rangeid');
            const $cell = $(this).find('.action-cell');
            $cell.append(`
                <button class="btn btn-sm btn-warning edit-range-btn" data-rangeid="${id}">
                    <i class="bi bi-pencil-square"></i> Edit
                </button>
                <button class="btn btn-sm btn-danger delete-range-btn" data-rangeid="${id}">
                    <i class="bi bi-trash"></i> Delete
                </button>
            `);
        });

        $(document).on('click', '.edit-range-btn', async function () {
            const id = $(this).data('rangeid');
            const res = await fetch(`/api/archeryrangeapi/${id}`, { headers: getAuthHeaders() });
            if (!res.ok) return alert('Failed to load range info.');
            const range = await res.json();
            $('#editRangeId').val(range.rangeID);
            $('#editDistance').val(range.distance);
            $('#editTargetFace').val(range.targetFace);
            $('#editNumEnds').val(range.numEnds);
            const modal = new bootstrap.Modal(document.getElementById('editRangeModal'));
            modal.show();
        });

        $(document).on('click', '.delete-range-btn', async function () {
            const id = $(this).data('rangeid');
            if (!confirm('Are you sure to delete this range?')) return;
            const res = await fetch(`/api/archeryrangeapi/${id}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });
            if (res.ok) {
                $(`tr[data-rangeid="${id}"]`).next().remove();
                $(`tr[data-rangeid="${id}"]`).remove();
                await updateTotalScoreFromServer();
            } else alert('Failed to delete range.');
        });
    }

    // ===== ADD RANGE =====
    $('#saveAddRangeBtn').on('click', async function () {
        const body = {
            competitionId,
            roundId,
            archerId,
            distance: parseInt($('#addDistance').val()),
            targetFace: $('#addTargetFace').val(),
            numEnds: parseInt($('#addNumEnds').val())
        };
        const res = await fetch('/api/archeryrangeapi', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
            body: JSON.stringify(body)
        });
        if (res.ok) {
            alert('✅ Range added!');
            location.reload();
        } else alert('❌ Failed to add range.');
    });

    // ===== EDIT RANGE =====
    $('#saveEditRangeBtn').on('click', async function () {
        const id = $('#editRangeId').val();
        const body = {
            rangeID: id,
            distance: parseInt($('#editDistance').val()),
            targetFace: $('#editTargetFace').val(),
            numEnds: parseInt($('#editNumEnds').val())
        };
        const res = await fetch(`/api/archeryrangeapi/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
            body: JSON.stringify(body)
        });
        if (res.ok) {
            alert('✅ Range updated!');
            location.reload();
        } else alert('❌ Failed to update range.');
    });

    // ===== LOAD ENDS =====
    async function loadEnds(rangeId, $container) {
        try {
            const res = await fetch(`/api/endapi/getbyrange/${rangeId}`, { headers: getAuthHeaders() });
            if (!res.ok) throw new Error('Failed to load ends');
            const ends = await res.json();
            if (!ends.length) return $container.html('<em>No ends found for this range.</em>');

            let html = `<table class="table table-sm table-hover mb-0"><thead><tr><th>End #</th><th>Arrows</th></tr></thead><tbody>`;
            for (const end of ends) {
                const arrows = await loadArrows(end.endID);
                let arrowInputs = arrows.map(a => {
                    const val = a.value ?? '';
                    return editable
                        ? `<input type="number" min="0" max="10" class="form-control form-control-sm arrow-input" data-arrowid="${a.arrowID}" value="${val}" style="width:60px; display:inline-block; margin-right:4px;">`
                        : `<span style="margin-right:6px;">${val || '-'}</span>`;
                }).join('');

                if (editable) arrowInputs += `<button class="btn btn-sm btn-success save-arrows-btn" data-endid="${end.endID}">💾 Save</button>`;
                html += `<tr><td>${end.endNumber || ''}</td><td>${arrowInputs || '-'}</td></tr>`;
            }
            html += '</tbody></table>';
            $container.html(html);
            if (editable) attachSaveHandlers($container);
        } catch (err) {
            console.error(err);
            $container.html('<span class="text-danger">Error loading ends.</span>');
        }
    }

    async function loadArrows(endId) {
        try {
            const res = await fetch(`/api/arrowapi/getbyend/${endId}`, { headers: getAuthHeaders() });
            if (!res.ok) throw new Error('Failed to load arrows');
            return await res.json();
        } catch { return []; }
    }

    function attachSaveHandlers($container) {
        $container.find('.save-arrows-btn').on('click', async function () {
            const $row = $(this).closest('tr');
            const inputs = $row.find('.arrow-input');
            for (const input of inputs) {
                const arrowId = $(input).data('arrowid');
                const value = parseInt($(input).val()) || 0;
                await fetch(`/api/arrowapi/${arrowId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
                    body: JSON.stringify({ value })
                });
            }
            alert('✅ Arrows updated!');
            await updateTotalScoreFromServer();
        });
    }

    async function updateTotalScoreFromServer() {
        try {
            const res = await fetch(`/api/scoreapi/gettotal/${competitionId}/${roundId}/${archerId}`, { headers: getAuthHeaders() });
            if (!res.ok) throw new Error('Failed to load total score');
            const data = await res.json();
            $('#totalScore').text(data.totalScore ?? 0);
        } catch (err) {
            console.error(err);
            $('#totalScore').text('Error');
        }
    }

    await updateTotalScoreFromServer();
});
    </script>
}
